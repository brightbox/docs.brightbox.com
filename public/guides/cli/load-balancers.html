<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <title>Brightbox - Load Balancers</title>
    <link href="http://localhost:4000/stylesheets/0reset.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="http://localhost:4000/stylesheets/960_24_col.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="http://localhost:4000/stylesheets/main.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="http://localhost:4000/stylesheets/buttons.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="http://localhost:4000/stylesheets/tiptip.css" media="screen" rel="stylesheet" type="text/css" />       
    <link href='http://fonts.googleapis.com/css?family=Droid+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />

    <script src="/javascripts/head.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-3144138-4']);
        _gaq.push(['_setDomainName', 'docs.brightbox.com']);
        _gaq.push(['_trackPageview']);

        (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
      </script>
  </head>
<body class="community">

 <header>
   <nav>
  <div id="nav_inner" class="container_24">
    <div id="logo"><h1><a href="/">Brightbox</a></h1></div>

    <ul class="primary">
      
        <li>
          <a href="http://brightbox.com"><span>brightbox.com</span></a>
        </li>
      
    </ul>

  </div>
</nav>


   <div id="banner" >

      <div class="container_24 small" id="banner_inner">

          <div id="title">
            <h2>Documentation.</h2>
          </div>
      </div>

    </div><!-- /banner -->
</header>

<div id="main">
  <div class="content container_24">
    
      
      <div id="breadcrumbs">
        
        	<a href="/">Overview</a> 
        	<b>&rsaquo;</b> 
        
        	<a href="/guides.html">Guides</a> 
        	<b>&rsaquo;</b> 
        
        	<a href="/guides/cli.html">CLI</a> 
        	<b>&rsaquo;</b> 
        
        	<a href="/guides/cli/load-balancers.html">Load Balancers</a> 
        	 
        
      </div>
      


    <h2>Load Balancers</h2>
    
    <p>Load Balancers distribute traffic between a pool of your servers, allowing you to scale your systems and have automatic fault tolerance. The balancer runs continuous health checks and removes any unresponsive servers from the pool until they recover.</p>

<p>Load Balancers are of course completely configurable via our API, and therefore also via our CLI tool.</p>

<p>This guide will show you how to create a new Load Balancer, add some servers and test it out.</p>

<h3 id='creating_a_new_balancer'>Creating a new balancer</h3>

<p>You manage Load Balancers using the <code>brightbox-lbs</code> command. We&#8217;re going to create a new balancer called <code>test</code> that will balance between two servers. It balances tcp port <code>80</code> by default, so we don&#8217;t need any other options:</p>

<pre><code>$ brightbox-lbs create -n &quot;test&quot; srv-hrmmb srv-h4lxv
Creating a new load balancer

 id         status    created_on  cloud_ips  nodes                 name
------------------------------------------------------------------------
 lba-c76a7  creating  2011-01-25             srv-hrmmb, srv-h4lxv  test
------------------------------------------------------------------------</code></pre>

<p>If we view the details of this new balancer, we can see that it is listening on port <code>80</code> and port <code>443</code> by default and is health checking port <code>80</code> with a http request. If three http requests to the backend servers fails in a row then the server will be taken out of the pool until it recovers:</p>

<pre><code>$ brightbox-lbs show lba-c76a7
         id: lba-c76a7
     status: active
       name: test
 created_at: 2011-01-25T17:48:20Z
 deleted_at: 
     policy: least-connections
  cloud_ips: 
      nodes: srv-hrmmb, srv-h4lxv
  listeners: 80:80:http,443:443:tcp
healthcheck: {&quot;threshold_down&quot;=&gt;3, &quot;port&quot;=&gt;80, &quot;timeout&quot;=&gt;5000, &quot;type&quot;=&gt;&quot;http&quot;, &quot;request&quot;=&gt;&quot;/&quot;, &quot;interval&quot;=&gt;5000, &quot;threshold_up&quot;=&gt;3}</code></pre>

<h3 id='mapping_a_cloud_ip_to_a_load_balancer'>Mapping a Cloud IP to a Load Balancer</h3>

<p>Once the balancer is created, we now map a Cloud IP to make it available on the internet:</p>

<pre><code>$ brightbox-cloudips map cip-tqg43 lba-c76a7
Mapping cip-tqg43 to load balancer lba-c76a7

 id         status  public_ip       destination  reverse_dns                         
--------------------------------------------------------------------------------------
 cip-tqg43  mapped  109.107.35.157  lba-c76a7    cip-109-107-35-157.gb1.brightbox.com
--------------------------------------------------------------------------------------</code></pre>

<h3 id='cloud_balancing_in_action'>Cloud Balancing in action</h3>

<p>Now that our balancer has an IP, we can use curl to see it in action:</p>

<pre><code>$ curl 109.107.35.157
I am server srv-hrmmb

$ curl 109.107.35.157
I am server srv-h4lxv

$ curl 109.107.35.157
I am server srv-hrmmb

$ curl 109.107.35.157
I am server srv-h4lxv</code></pre>

<h3 id='listeners'>Listeners</h3>

<p>Load Balancers listen on port <code>80</code> in http mode and port <code>443</code> in tcp mode by default. HTTP requests get a <code>X-Forwarded-For</code> header added as they pass through the balancer, so your web servers can find the user&#8217;s IP address. TCP mode doesn&#8217;t modify the request at all, so it can be used for SSL and other types of connections (like MySQL or SMTP).</p>

<p>You can specify your own listeners in the format <code>in-port:out-port:type</code>. <code>in-port</code> is the port that the load balancer listens on and <code>type</code> is the mode, currently <code>http</code> or <code>tcp</code>. <code>out-port</code> is the port the load balancer will connect to on your back end servers - usually this will be the same as <code>in-port</code>. You can comma separate multiple listeners.</p>

<p>For example, if you want to change your balancer to handle your mail servers you could change the listeners for IMAP and SSL IMAP:</p>

<pre><code>$ brightbox-lbs update -l 143:143:tcp,993:993:tcp lba-c76a7</code></pre>

<p>If you want your site available on multiple ports <code>80</code>, <code>90</code> and <code>100</code>, you&#8217;d use:</p>

<pre><code>$ brightbox-lbs update -l 80:80:http,90:80:http,100:80:http lba-c76a7</code></pre>

<p>All these options can be set at creation time too.</p>

<h3 id='health_checks'>Health Checks</h3>

<p>By default, the cli will set up a health check based on your first listener. So if your first listener tcp port <code>25</code> (SMTP), then the health check will be a tcp connect to port <code>25</code> on your back end servers.</p>

<p>If your first listener is a http listener than the health check will be a HTTP request expecting a <code>HTTP 200</code> response.</p>

<p>You can, of course, specify your own health checks.</p>

<p>To make a http health check request for <code>/status.html</code> on your back end servers:</p>

<pre><code>$ brightbox-lbs update --hc-type http --hc-port 80 --hc-request &quot;/status.html&quot; lba-c76a7</code></pre>

<p>To make a tcp connect check on port <code>22</code>:</p>

<pre><code>$ brightbox-lbs update --hc-type tcp --hc-port 22 lba-c76a7</code></pre>

<p>The options <code>--hc-down</code> and <code>--hc-up</code> set how many consecutive health checks need to fail or succeed for the back end server to be considered down, or up.</p>

<p>The option <code>--hc-timeout</code> specifies how long the balancer will wait for a successful response to a health check. If your back end server doesn&#8217;t respond in this time then the health check is considered a failure.</p>

<p>All these options can be set at creation time too.</p>
  </div><!-- /content -->
</div><!-- /main -->


<footer>
<div id="footer_inner" class="container_24">
  <div class="grid_9 alpha">
  <h4>Follow @brightbox</h4>  
    
  <p class="social">
    <a href="http://twitter.com/brightbox" title="Twitter (@brightbox)" class="tip"><img src="/images/icons/twitter.png" /></a> 
    <a href="http://facebook.com/brightbox" title="Facebook" class="tip"><img src="/images/icons/facebook.png" /></a> 
    <a href="http://flickr.com/brightbox" title="Flickr" class="tip"><img src="/images/icons/flickr.png" /></a> 
    <a href="http://github.com/brightbox" title="GitHub" class="tip"><img src="/images/icons/github.png" /></a> 
    <a href="http://youtube.com/brightbox" title="YouTube" class="tip"><img src="/images/icons/youtube.png" /></a> 
  </p>
    
   <form id="subscribe" action="http://brightbox.createsend.com/t/y/s/bykuul/" method="post">
     <label for="bykuul-bykuul">Receive email updates about new products, features and other news (unsubscribe anytime).</label>
     
      <p>
        <input type="text" name="cm-bykuul-bykuul" id="bykuul-bykuul" placeholder="your email" />
      <button type="submit">subscribe</button></p>
    </form>
    <p class="copyright">Copyright &copy; 2011 Brightbox Systems Ltd</p>
    <p class="links">
      <a href="/legal/terms">Terms &amp; Conditions</a> &bull; 
      <a href="https://api.gb1.brightbox.com/1.0/">API</a> &bull; 
      <a href="http://docs.brightbox.com">Documentation</a> &bull;
      <a href="/about/contact">Contact us</a>
    </p>
  </div>

  <div class="clear">.</div>

<a href="http://github.com/brightbox/brightbox-docs" target="_blank"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://a248.e.akamai.net/assets.github.com/img/e6bef7a091f5f3138b8cd40bc3e114258dd68ddf/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub"></a>
  
</div>
</footer>

   <script type="text/javascript">
    head.js(
     { 'before': '/javascripts/before.js' },
     { 'jquery': 'http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js' },
     { 'jquery.smooth-scroll': '/javascripts/jquery.smooth-scroll.min.js' },
     { 'jquery.twitter': '/javascripts/jquery.twitter.js' },
     { 'jquery.tiptip': '/javascripts/jquery.tiptip.min.js' },
     { 'jquery.fancyzoom': '/javascripts/jquery.fancyzoom.js' },
     { 'disqus': 'http://brightbox.disqus.com/embed.js' },
     { 'jqueryui': 'http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.15/jquery-ui.min.js' },
  </script>
</body>
</html>
